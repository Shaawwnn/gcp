steps:
  # Step 1: Install workspace dependencies
  - name: 'node:22-slim'
    entrypoint: 'yarn'
    args: ['install', '--frozen-lockfile']

  # Comment out for free tier (for now)

  # Step 2: Build Cloud Run Docker image (commented out for free tier)
  # - name: 'gcr.io/cloud-builders/docker'
  #   args: [
  #     'build',
  #     '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-apps/cloud-run-learning:$BUILD_ID',
  #     '.'
  #   ]
  #   dir: 'cloud-run'

  # Step 3: Push image to Artifact Registry (commented out for free tier)
  # - name: 'gcr.io/cloud-builders/docker'
  #   args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-apps/cloud-run-learning:$BUILD_ID']

  # Step 4: Deploy Cloud Run service (commented out - requires Step 3)
  # - name: 'gcr.io/cloud-builders/gcloud'
  #   args: [
  #     'run',
  #     'deploy',
  #     'cloud-run-learning',
  #     '--image', 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-apps/cloud-run-learning:$BUILD_ID',
  #     '--region', 'us-central1',
  #     '--platform', 'managed',
  #     '--allow-unauthenticated'
  #   ]

  # Step 5: Deploy Firebase Functions (backend)
  - name: 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-apps/firebase:v1'
    args: [
      'deploy',
      '--only', 'functions',
      '--non-interactive',
      '--project', '$PROJECT_ID'
    ]

  # Step 6: Build Next.js client
  - name: 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-apps/nextjs:v1'
    args: ['cd client && yarn build']
    
  # Step 7: Deploy Hosting (frontend)
  - name: 'us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-apps/firebase:v1'
    args: [
      'deploy',
      '--only', 'hosting',
      '--non-interactive',
      '--project', '$PROJECT_ID'
    ]

# Logging configuration (required when using custom service account)
options:
  logging: CLOUD_LOGGING_ONLY
